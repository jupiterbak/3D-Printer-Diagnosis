; DEFs
N100 DEF REAL START_RADIUS = 13.0
N110 DEF REAL RADIUS = 13.0
N120 DEF REAL SKIRTRAD = 2.0
N130 DEF REAL XY_INCR = 0.40
N140 DEF REAL XY_POS = 0.0
N150 DEF REAL Z_INCR = 0.40
N160 DEF REAL Z_OFFSET = -0.20
N170 DEF REAL Z_POS = 0.0
N180 DEF INT COL_COUNT = 0
N190 DEF INT ROWPAIR_COUNT = 0
N200 DEF REAL EXT_FACT = 18
N210 DEF REAL SQ05 = 0.70710678
N220 DEF REAL TILT_COEF = 0.001
N230 DEF REAL SIN10
N240 DEF REAL COS10

; Init
N250 SIN10 = SIN(10)
N260 COS10 = COS(10)
N270 TRACON
N280 COMPCAD
N290 G500
N300 G641 ADIS=2 ;SMOOTH CORNERS
N310 ORIVECT
N320 MSG("Check: Extruder ready?")
N330 M0

; Approach and Skirt
N340 MSG("Approach and Skirt")
N350 G0 X0 Y0 Z120 B0 C0
N360 X=-50 Y=-40 Z=20
;STOPRE
N370 SKIRTRAD = 2.0
N380 Z_POS=Z_INCR+Z_OFFSET
N390 G1 X=-40 Y=-40 Z=Z_POS+1 F2000 EXT=IC(15)
N400 X=40 Z=Z_POS EXT=IC(80/EXT_FACT)
N410 G3 Y=IC(2*SKIRTRAD) I=0 J=SKIRTRAD EXT=IC($PI*SKIRTRAD/EXT_FACT)
N420 G1 X=-40 F5000 EXT=IC(80/EXT_FACT)
N430 G2 Y=IC(2*SKIRTRAD) I=0 J=SKIRTRAD  EXT=IC($PI*SKIRTRAD/EXT_FACT)
N440 G1 X=RADIUS F6000 EXT=IC(80/EXT_FACT)

; Print loops 
N450 MSG("Print loop...")
;Z_POS=Z_POS-Z_OFFSET
N460 ORIAXES
N470 COMPON
N480 G1 X=RADIUS Y=0 Z=Z_POS A3=TILT_COEF B3=0 C3=1 F6000
;BTAN ETAN ; used by ASPLINE

; ***** Segment 1 - base cylinder
N490 MSG("Print loop - segment 1...")
N500 FOR ROWPAIR_COUNT = 1 TO 15
   ; IN --> OUT
N510   FOR COL_COUNT = 1 TO 5
N520      G3 I=AC(0.0) J=AC(0.0) AR=90 A3=0 B3=TILT_COEF C3=1 EXT=IC(0.5*$PI*RADIUS/EXT_FACT)
N530      G3 I=AC(0.0) J=AC(0.0) AR=90 A3=-TILT_COEF B3=0 C3=1 EXT=IC(0.5*$PI*RADIUS/EXT_FACT)
N540      G3 I=AC(0.0) J=AC(0.0) AR=90 A3=0 B3=-TILT_COEF C3=1 EXT=IC(0.5*$PI*RADIUS/EXT_FACT)
N550      G3 I=AC(0.0) J=AC(0.0) AR=80 A3=COS10*TILT_COEF B3=-SIN10*TILT_COEF C3=1 EXT=IC(0.44*$PI*RADIUS/EXT_FACT)
N560      RADIUS = RADIUS + XY_INCR
N570      IF COL_COUNT < 5
N580       ASPLINE X=RADIUS Y=0 A3=TILT_COEF B3=0 C3=1 EXT=IC(0.06*$PI*RADIUS/EXT_FACT)
N590      ENDIF
N600   ENDFOR ; COL_COUNT

N610   Z_POS = Z_POS + Z_INCR
N620   RADIUS = RADIUS - XY_INCR
N630 ASPLINE X=RADIUS Y=0 Z=Z_POS A3=TILT_COEF B3=0 C3=1 EXT=IC(0.06*$PI*RADIUS/EXT_FACT)
   ; OUT --> IN
N640   FOR COL_COUNT = 1 TO 5
N650     G3 I=AC(0.0) J=AC(0.0) AR=90 A3=0 B3=TILT_COEF C3=1 EXT=IC(0.5*$PI*RADIUS/EXT_FACT)
N660     G3 I=AC(0.0) J=AC(0.0) AR=90 A3=-TILT_COEF B3=0 C3=1 EXT=IC(0.5*$PI*RADIUS/EXT_FACT)
N670     G3 I=AC(0.0) J=AC(0.0) AR=90 A3=0 B3=-TILT_COEF C3=1 EXT=IC(0.5*$PI*RADIUS/EXT_FACT)
N680     G3 I=AC(0.0) J=AC(0.0) AR=80 A3=COS10*TILT_COEF B3=-SIN10*TILT_COEF C3=1 EXT=IC(0.44*$PI*RADIUS/EXT_FACT)
N690     RADIUS = RADIUS - XY_INCR
N700     IF COL_COUNT < 5
N710      ASPLINE X=RADIUS Y=0 A3=TILT_COEF B3=0 C3=1 EXT=IC(0.06*$PI*RADIUS/EXT_FACT)
N720     ENDIF
N730   ENDFOR ; COL_COUNT
N740   Z_POS = Z_POS + Z_INCR
N750   RADIUS = RADIUS + XY_INCR
N760 ASPLINE X=RADIUS Y=0 Z=Z_POS A3=TILT_COEF B3=0 C3=1 EXT=IC(0.06*$PI*RADIUS/EXT_FACT)
N770 ENDFOR ; ROWPAIR_COUNT

; ***** Segment 2 - reorientation step 1
N780 MSG("Print loop - segment 2...")
; IN --> OUT
N790 FOR COL_COUNT = 1 TO 4
N800   G3 I=AC(0.0) J=AC(0.0) AR=90 A3=0 B3=TILT_COEF C3=1 EXT=IC(0.5*$PI*RADIUS/EXT_FACT)
N810   G3 I=AC(0.0) J=AC(0.0) AR=90 A3=-TILT_COEF B3=0 C3=1 EXT=IC(0.5*$PI*RADIUS/EXT_FACT)
N820   G3 I=AC(0.0) J=AC(0.0) AR=90 A3=0 B3=-TILT_COEF C3=1 EXT=IC(0.5*$PI*RADIUS/EXT_FACT)
N830   G3 I=AC(0.0) J=AC(0.0) AR=80 A3=COS10*TILT_COEF B3=-SIN10*TILT_COEF C3=1 EXT=IC(0.44*$PI*RADIUS/EXT_FACT)
N840   RADIUS = RADIUS + XY_INCR
N850   IF COL_COUNT < 4
N860    ASPLINE X=RADIUS Y=0 A3=TILT_COEF B3=0 C3=1 EXT=IC(0.06*$PI*RADIUS/EXT_FACT)
N870   ENDIF
N880 ENDFOR ; COL_COUNT

N890 Z_POS = Z_POS + Z_INCR
N900 RADIUS = RADIUS - 2*XY_INCR
N910 ASPLINE X=RADIUS Y=0 Z=Z_POS A3=TILT_COEF B3=0 C3=1 EXT=IC(0.06*$PI*RADIUS/EXT_FACT)

; OUT --> IN
N920 FOR COL_COUNT = 1 TO 3
N930   G3 I=AC(0.0) J=AC(0.0) AR=90 A3=0 B3=TILT_COEF C3=1 EXT=IC(0.5*$PI*RADIUS/EXT_FACT)
N940   G3 I=AC(0.0) J=AC(0.0) AR=90 A3=-TILT_COEF B3=0 C3=1 EXT=IC(0.5*$PI*RADIUS/EXT_FACT)
N950   G3 I=AC(0.0) J=AC(0.0) AR=90 A3=0 B3=-TILT_COEF C3=1 EXT=IC(0.5*$PI*RADIUS/EXT_FACT)
N960   G3 I=AC(0.0) J=AC(0.0) AR=80 A3=COS10*TILT_COEF B3=-SIN10*TILT_COEF C3=1 EXT=IC(0.44*$PI*RADIUS/EXT_FACT)
N970   RADIUS = RADIUS - XY_INCR
N980   IF COL_COUNT < 3
N990    ASPLINE X=RADIUS Y=0 A3=TILT_COEF B3=0 C3=1 EXT=IC(0.06*$PI*RADIUS/EXT_FACT)
N1000  ENDIF
N1010 ENDFOR ; COL_COUNT
N1020 Z_POS = Z_POS + SQ05*Z_INCR
N1030 RADIUS = RADIUS + 1.5*XY_INCR
N1040 ASPLINE X=RADIUS Y=0 Z=Z_POS A3=TILT_COEF B3=0 C3=1 EXT=IC(0.06*$PI*RADIUS/EXT_FACT)
N1050 G3 I=AC(0.0) J=AC(0.0) AR=90 A3=0 B3=TILT_COEF C3=1 EXT=IC(0.5*$PI*RADIUS/EXT_FACT)
N1060 G3 I=AC(0.0) J=AC(0.0) AR=90 A3=-TILT_COEF B3=0 C3=1 EXT=IC(0.5*$PI*RADIUS/EXT_FACT)
N1070 G3 I=AC(0.0) J=AC(0.0) AR=90 A3=0 B3=-TILT_COEF C3=1 EXT=IC(0.2*$PI*RADIUS/EXT_FACT)
N1080 G3 I=AC(0.0) J=AC(0.0) AR=80 A3=COS10*TILT_COEF B3=-SIN10*TILT_COEF C3=1 EXT=IC(0.44*$PI*RADIUS/EXT_FACT)

; ***** Segment 3 - reorientation step 2
N1090 MSG("Print loop - segment 3...")
; IN --> OUT
N1100 TILT_COEF = 1 ; actual reorientation
N1110 Z_POS = Z_POS + 0.5*Z_INCR
N1120 RADIUS = RADIUS + 0.5*XY_INCR
N1130 ASPLINE X=RADIUS Y=0 Z=Z_POS A3=TILT_COEF B3=0 C3=1 EXT=IC(0.06*$PI*RADIUS/EXT_FACT)

N1140 G3 I=AC(0.0) J=AC(0.0) AR=90 A3=0 B3=TILT_COEF C3=1 EXT=IC(0.5*$PI*RADIUS/EXT_FACT)
N1150 G3 I=AC(0.0) J=AC(0.0) AR=90 A3=-TILT_COEF B3=0 C3=1 EXT=IC(0.5*$PI*RADIUS/EXT_FACT)
N1160 G3 I=AC(0.0) J=AC(0.0) AR=90 A3=0 B3=-TILT_COEF C3=1 EXT=IC(0.5*$PI*RADIUS/EXT_FACT)
N1170 G3 I=AC(0.0) J=AC(0.0) AR=80 A3=COS10*TILT_COEF B3=-SIN10*TILT_COEF C3=1 EXT=IC(0.44*$PI*RADIUS/EXT_FACT)

N1180 Z_POS = Z_POS - SQ05*Z_INCR
N1190 RADIUS = RADIUS + SQ05*XY_INCR
N1200 ASPLINE X=RADIUS Y=0 Z=Z_POS A3=TILT_COEF B3=0 C3=1 EXT=IC(0.06*$PI*RADIUS/EXT_FACT)

N1210 G3 I=AC(0.0) J=AC(0.0) AR=90 A3=0 B3=TILT_COEF C3=1 EXT=IC(0.5*$PI*RADIUS/EXT_FACT)
N1220 G3 I=AC(0.0) J=AC(0.0) AR=90 A3=-TILT_COEF B3=0 C3=1 EXT=IC(0.5*$PI*RADIUS/EXT_FACT)
N1230 G3 I=AC(0.0) J=AC(0.0) AR=90 A3=0 B3=-TILT_COEF C3=1 EXT=IC(0.5*$PI*RADIUS/EXT_FACT)
N1240 G3 I=AC(0.0) J=AC(0.0) AR=80 A3=COS10*TILT_COEF B3=-SIN10*TILT_COEF C3=1 EXT=IC(0.44*$PI*RADIUS/EXT_FACT)

; ***** Segment 4 - continue with funnel - reoriented
N1250 MSG("Print loop - segment 4...")
N1260 Z_POS = Z_POS + 2*SQ05*Z_INCR
N1270 RADIUS = RADIUS + (SQ05-1)*XY_INCR
N1280 ASPLINE X=RADIUS Y=0 Z=Z_POS A3=TILT_COEF B3=0 C3=1 EXT=IC(0.06*$PI*RADIUS/EXT_FACT)

N1290 FOR ROWPAIR_COUNT = 1 TO 20
   ; IN --> OUT
N1300   FOR COL_COUNT = 1 TO 5
N1310      G3 I=AC(0.0) J=AC(0.0) AR=90 A3=0 B3=TILT_COEF C3=1 EXT=IC(0.5*$PI*RADIUS/EXT_FACT)
N1320      G3 I=AC(0.0) J=AC(0.0) AR=90 A3=-TILT_COEF B3=0 C3=1 EXT=IC(0.5*$PI*RADIUS/EXT_FACT)
N1330      G3 I=AC(0.0) J=AC(0.0) AR=90 A3=0 B3=-TILT_COEF C3=1 EXT=IC(0.5*$PI*RADIUS/EXT_FACT)
N1340      G3 I=AC(0.0) J=AC(0.0) AR=80 A3=COS10*TILT_COEF B3=-SIN10*TILT_COEF C3=1 EXT=IC(0.44*$PI*RADIUS/EXT_FACT)
N1350      RADIUS = RADIUS + SQ05*XY_INCR
N1360      Z_POS = Z_POS - SQ05*Z_INCR
N1370      IF COL_COUNT < 5
N1380       ASPLINE X=RADIUS Y=0 A3=TILT_COEF Z=Z_POS B3=0 C3=1 EXT=IC(0.06*$PI*RADIUS/EXT_FACT)
N1390      ENDIF
N1400   ENDFOR ; COL_COUNT

N1410   Z_POS = Z_POS + 2*SQ05*Z_INCR
   ;RADIUS = RADIUS
N1420   ASPLINE X=RADIUS Y=0 Z=Z_POS A3=TILT_COEF B3=0 C3=1 EXT=IC(0.06*$PI*RADIUS/EXT_FACT)

   ; OUT --> IN
N1430   FOR COL_COUNT = 1 TO 5
N1440      G3 I=AC(0.0) J=AC(0.0) AR=90 A3=0 B3=TILT_COEF C3=1 EXT=IC(0.5*$PI*RADIUS/EXT_FACT)
N1450      G3 I=AC(0.0) J=AC(0.0) AR=90 A3=-TILT_COEF B3=0 C3=1 EXT=IC(0.5*$PI*RADIUS/EXT_FACT)
N1460      G3 I=AC(0.0) J=AC(0.0) AR=90 A3=0 B3=-TILT_COEF C3=1 EXT=IC(0.5*$PI*RADIUS/EXT_FACT)
N1470      G3 I=AC(0.0) J=AC(0.0) AR=80 A3=COS10*TILT_COEF B3=-SIN10*TILT_COEF C3=1 EXT=IC(0.44*$PI*RADIUS/EXT_FACT)
N1480      RADIUS = RADIUS - SQ05*XY_INCR
N1490      Z_POS = Z_POS + SQ05*Z_INCR
N1500      IF COL_COUNT < 5
N1510       ASPLINE X=RADIUS Y=0 Z=Z_POS A3=TILT_COEF B3=0 C3=1 EXT=IC(0.06*$PI*RADIUS/EXT_FACT)
N1520      ENDIF
N1530   ENDFOR ; COL_COUNT
   ; Z_POS = Z_POS
N1540   RADIUS = RADIUS + 2*SQ05*XY_INCR
N1550   ASPLINE X=RADIUS Y=0 Z=Z_POS A3=TILT_COEF B3=0 C3=1 EXT=IC(0.06*$PI*RADIUS/EXT_FACT)
N1560 ENDFOR ; ROWPAIR_COUNT

; RETRACT
N1570 MSG("Retract - finished")
N1580 ORIVECT
N1590 COMPOF
N1600 G0 Z=120 EXT=IC(-15)
N1610 G0 X0 Y40 Z150 B0 C0
N1620 ORIRESET
N1630 B0 C0
N1640 M30
